# 客户端授权方案（用户名密码 MVP）

## 1. 方案目标
- **最简落地**：客户端仅需用户名、密码即可登录运行，无需额外授权包或设备指纹。
- **远程管控**：管理端可随时调整账号的使用期限或禁用状态，客户端在下一次登录或刷新时生效。
- **兼容现有流程**：在主程序启动前插入登录校验，其他业务逻辑保持不变。

## 2. 功能范围
| 能力 | 是否包含 | 说明 |
| --- | --- | --- |
| 用户名/密码登录 | ✅ | 客户端启动时先登录，成功后才允许运行主流程 |
| 远程有效期管理 | ✅ | 管理端设置账号 `expires_at` 或禁用账号 |
| 登录后的状态刷新 | ✅ | 客户端定时调用状态接口校验账号是否仍有效 |
| 设备绑定、并发控制 | ❌ | 后续迭代再考虑 |
| 审计报表/操作日志 | ❌ | 后续迭代再补充 |

## 3. 关键角色
- **客户端用户**：使用用户名/密码登录运行程序。
- **管理端运维人员**：在后台为账号设置有效期、启用或禁用状态。
- **认证服务（Auth Service）**：提供登录与状态查询接口，维护账号信息。

## 4. 架构简图
```
┌────────┐        HTTPS         ┌────────────────┐
│ 管理后台 │ ────────────────▶ │ 认证服务（MVP） │
└────────┘                     └────────────────┘
                                      ▲
                                      │
                                    登录
                                      │
                                      ▼
                              ┌────────────────┐
                              │ 客户端程序     │
                              └────────────────┘
```

### 4.1 认证服务接口（最小集合）
1. `POST /auth/login`
   - 入参：`username`, `password`, `client_version`
   - 出参：`access_token`, `expires_at`, `message`
2. `GET /auth/status`
   - Header：`Authorization: Bearer <access_token>`
   - 出参：`account_status`, `expires_at`, `message`

> 注：MVP 阶段使用内存数据库或简单关系表均可，后续再扩展。

## 5. 数据模型（MVP 最小集合）
表：`users`
- `id`: 主键
- `username`: 登录名（唯一）
- `password_hash`: 采用 Bcrypt 或 Argon2 存储
- `status`: `active` / `disabled`
- `expires_at`: UTC 时间，过期后拒绝登录
- `updated_at`: 管理端最后一次修改时间
- `last_login_at`（可选）：用于简单审计

管理后台仅需在此表上提供增删改查及有效期编辑即可。

## 6. 客户端交互流程
1. **登录**
   - 启动程序前弹出或读取配置中的用户名、密码。
   - 请求 `POST /auth/login`。
   - 若返回状态为 `active` 且当前时间 < `expires_at`，保存 `access_token` 和 `expires_at`（写入加密本地文件）。
2. **启动主逻辑**
   - 将 `access_token` 注入后续业务请求头（如需要），并进入既有主流程。
3. **周期校验**
   - 每 15 分钟调用一次 `GET /auth/status`；若返回 `disabled` 或 `expires_at` 已过期，立即退出并提示用户联系管理员。
4. **重新登录**
   - 当密码变更或 `access_token` 失效时，客户端提示重新输入凭证。

## 7. 管理端操作
- 在后台维护 `users` 表：
  - 创建或删除账号；
  - 调整 `expires_at`（支持立即生效或预设未来时间）；
  - 将 `status` 设为 `disabled` 即可远程停用账号。
- 客户端下一次登录或状态刷新即会感知变更。

## 8. 安全与可靠性
- **通信安全**：所有接口通过 HTTPS，强制 TLS1.2+。
- **密码存储**：仅存储哈希值，禁止明文；推荐使用 Bcrypt(12+) 或 Argon2。
- **令牌生成**：`access_token` 可使用 JWT（HS256）或随机字符串 + Redis 映射；MVP 阶段建议后者，便于撤销令牌。
- **本地存储**：客户端缓存令牌时进行简单加密（对称密钥）或依赖系统安全存储。
- **时间同步**：服务端在响应中附带 `server_time`，客户端以服务端时间为准判断过期。
- **失败策略**：
  - 登录失败立即阻断启动；
  - 心跳失败时短时重试，连续失败超 3 次则提示用户检查网络。

## 9. 迭代方向
1. 引入设备指纹、并发控制、黑名单等精细策略。
2. 扩展日志审计、操作轨迹和告警能力。
3. 接入第三方身份系统（SSO、企业微信等）。
4. 封装统一授权 SDK，提供更丰富的缓存与降级策略。

---
该方案以最小实现成本完成“用户名密码登录 + 远程有效期管理”，满足即时上线需求，并为后续功能扩展预留空间。