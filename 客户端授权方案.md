# 客户端授权方案（MVP 版本）

## 1. 目标
- **最小可行性**：在不大幅改造现有系统的前提下，为每个客户端提供可远程配置的授权有效期。
- **快速落地**：优先实现远程启停与有效期校验，后续再扩展并发限制、灰度策略等高级能力。

## 2. MVP 范围
| 能力 | 是否包含 | 说明 |
| --- | --- | --- |
| 客户端启动前授权校验 | ✅ | 启动时校验本地缓存，无法通过则拒绝运行 |
| 远程调整有效期/启停 | ✅ | 通过简单后台或配置文件更新授权信息 |
| 授权心跳 / 定时刷新 | ✅ | 固定间隔拉取最新授权快照 |
| 黑名单、灰度策略 | ❌ | 后续迭代 |
| 并发数控制 | ❌ | 后续迭代 |
| 复杂审计报表 | ❌ | 后续迭代 |

## 3. 架构总览
```
┌──────────────┐      HTTPS/REST      ┌─────────────────┐
│ 运营后台（简版）│ ─────────────────→ │ 授权配置服务（MVP）│
└──────────────┘                      └────────┬────────┘
                                               │
                                               ▼
                                          JSON 配置库

客户端 ──(启动/心跳)──▶ 授权配置服务 ──▶ 返回授权快照
```

### 3.1 组件说明
- **授权配置服务（MVP）**
  - 单体应用，提供 2 个核心接口：
    - `GET /licenses/{device_id}`：返回授权快照
    - `POST /licenses/{device_id}/refresh`：客户端心跳触发刷新
  - 数据源可先采用一张关系型表或加密 JSON 文件存储。
- **运营后台（简版）**
  - 管理员登录后可检索设备、修改 `expires_at`、启用/停用。
  - MVP 阶段可用现成低码工具（Retool、Metabase）或简易 Django Admin。
- **客户端授权模块**
  - 启动阶段：本地校验 + 远程获取快照；
  - 运行阶段：定时心跳（10~15 分钟）拉取最新授权。

## 4. 数据模型（简化）
仅保留授权运行必需字段：
- `device_id`: 设备唯一标识（机器指纹或手动录入）
- `customer_name`: 便于排查的文本信息
- `license_status`: `active` / `disabled`
- `expires_at`: UTC 时间戳
- `last_synced_at`: 记录客户端最近一次同步时间（由服务端更新）

> MVP 阶段，将数据存于单表 `licenses` 或者 `licenses.json` 文件，后续需要时再拆分 customer/device 结构。

## 5. 核心流程

### 5.1 客户端启动
1. 读取本地授权快照（JSON），校验：
   - `license_status == active`
   - `now <= expires_at`
2. 若校验失败则直接退出，并提示“授权已失效，请联系管理员”。
3. 若校验通过，则向授权服务发起 `GET /licenses/{device_id}` 获取最新快照：
   - 服务端返回 `{ license_status, expires_at, message }`
   - 客户端将快照覆盖本地缓存。

### 5.2 心跳刷新
- 每 10 分钟调用 `POST /licenses/{device_id}/refresh`，携带当前版本、运行状态。
- 服务端返回最新授权快照；若状态变更（例如远程禁用），客户端立即停止。

### 5.3 运维调整
- 运维人员通过后台修改某设备的 `license_status` 或 `expires_at`。
- 变更实时写入数据库/JSON。
- 客户端下一次心跳或启动立即感知变更。

## 6. 安全与稳定性（MVP）
- **通信**：服务端启用 HTTPS，使用基础认证（Basic Auth）或预共享密钥（Header Token）。
- **数据保护**：本地授权快照以简单加密（对称密钥）保存，避免明文泄漏。
- **时间校准**：授权服务返回 `server_time`；客户端使用 `min(now, server_time)` 进行过期判断，减小时间偏差。
- **失败兜底**：
  - 若网络断开但本地快照仍在有效期内，允许继续运行；
  - 若超过有效期仍无法连接服务，则拒绝运行。

## 7. 迭代展望
在 MVP 稳定后，可逐步补充：
1. 并发会话限制、黑名单。
2. 细化数据模型（客户、设备、操作日志）。
3. 强化安全（JWT、非对称签名、审计日志）。
4. 接入 Prometheus/Grafana 做监控告警。

---
本方案旨在用最少组件实现“远程配置客户端有效期”的基础能力，优先保障可用性与上线速度，后续可按业务需求逐步完善。