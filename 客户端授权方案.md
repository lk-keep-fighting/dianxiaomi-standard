# 客户端授权方案（Supabase + 本地缓存）

## 1. 方案目标
- **启动前强制授权**：在执行 `src/main.py` 的既有逻辑之前，必须完成账号登录与有效期校验。
- **每日刷新有效性**：授权结果会缓存到本地，但至少每天都会向服务端复核一次有效期，确保停用/过期策略 24 小时内生效。
- **Supabase 托管数据**：账号信息、有效期与禁用状态全部由 Supabase 存储和维护，客户端仅负责读取校验。
- **无侵入改造**：授权模块以独立组件 `client_authorization.py` 形式存在，不影响主流程代码结构。

## 2. 功能范围
| 能力 | 是否包含 | 说明 |
| --- | --- | --- |
| 用户名/密码登录 | ✅ | 启动时收集凭证（支持 `.env` 或交互输入）。|
| Supabase 有效期校验 | ✅ | 读取 `client_licenses` 表获取状态、有效期并本地缓存。|
| 每日有效期刷新 | ✅ | 同一天内复用本地缓存，次日或缓存失效时重新向 Supabase 验证。|
| 本地授权缓存 | ✅ | 结果写入 `data/auth_states/client_authorization_state.json`。|
| 设备绑定、并发控制 | ❌ | 后续迭代再考虑。|
| 审计报表/操作日志 | ❌ | 由 Supabase 或后台系统后续补充。|

## 3. 关键角色
- **客户端用户**：运行脚本，输入授权账号与密码。
- **管理端运维**：在 Supabase 数据库中维护账号的有效期与启停状态。
- **Supabase**：统一存储授权数据，通过 REST 接口向客户端提供查询能力。

## 4. 架构与数据流
```
┌────────┐        数据维护         ┌──────────────────────┐
│ 管理后台 │ ─────────────────────▶ │ Supabase (Postgres) │
└────────┘                         └──────────────────────┘
                                          ▲
                                          │ REST（apikey）
                                          │
                                  ┌──────────────────────┐
                                  │ client_authorization │
                                  │  本地缓存 + 每日校验 │
                                  └──────────────────────┘
                                          │ 授权通过
                                          ▼
                                   ┌────────────────┐
                                   │ src/main.py 主流程 │
                                   └────────────────┘
```

### 4.1 Supabase 资源
- **表名**：`client_licenses`（可通过环境变量覆盖）。
- **访问方式**：使用 Supabase REST API（`https://<project>.supabase.co/rest/v1/<table>`）。
- **授权**：客户端携带 `SUPABASE_API_KEY`（建议使用具备最小读取权限的 key）。

### 4.2 本地缓存
- 缓存文件路径：`data/auth_states/client_authorization_state.json`。
- 缓存内容：用户名、授权状态、有效期、最近一次校验时间、服务端返回的其他元数据（已剔除密码字段）。
- 缓存策略：
  - 当天已校验且未过期 → 直接复用缓存。
  - 缓存缺失、损坏或跨天使用 → 自动向 Supabase 重新校验。

## 5. 数据模型（Supabase `client_licenses` 表）
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` | uuid / bigint | 主键（由 Supabase 自动生成）。|
| `username` | text (unique) | 登录用户名。|
| `password_hash` | text | 使用 Bcrypt 存储的密码哈希（客户端兼容明文退化）。|
| `status` | text | `active` / `disabled`，也兼容 `true/false`、`1/0` 语义。|
| `expires_at` | timestamptz | 授权到期时间（UTC）。|
| `updated_at` | timestamptz | 最近一次修改时间。|

> 若需自定义字段名称，可在客户端通过 `SUPABASE_*_COLUMN` 环境变量覆写。

## 6. 客户端执行流程
1. **加载缓存**：读取 `client_authorization_state.json`，判断是否还在有效期且校验日期为今日。
2. **凭证收集**：
   - 优先使用 `.env` 中的 `CLIENT_AUTH_USERNAME` / `CLIENT_AUTH_PASSWORD`。
   - 若环境变量缺失，则通过命令行交互提示用户输入。
3. **远程校验**：
   - 请求 Supabase REST 接口获取账号记录。
   - 使用 Bcrypt 校验密码（若服务端存储为明文则直接比对）。
   - 检查 `status` 与 `expires_at`，拒绝禁用或过期的账号。
4. **写入缓存**：保存新的授权结果及元数据，供当日后续运行直接复用。
5. **进入主流程**：`ensure_client_authorized()` 在 `main()` 的第一时间执行，通过后才继续既有业务逻辑。

## 7. 环境变量与配置
| 变量名 | 说明 | 默认值 |
| --- | --- | --- |
| `SUPABASE_URL` | Supabase 项目的根地址（例如 `https://xxxx.supabase.co`）。 | — |
| `SUPABASE_API_KEY` | 具备读取授权表的 API Key。 | — |
| `SUPABASE_CLIENT_TABLE` | 授权数据表名。 | `client_licenses` |
| `SUPABASE_USERNAME_COLUMN` | 用户名字段名。 | `username` |
| `SUPABASE_PASSWORD_COLUMN` | 密码/哈希字段名。 | `password_hash` |
| `SUPABASE_STATUS_COLUMN` | 状态字段名。 | `status` |
| `SUPABASE_EXPIRES_COLUMN` | 到期时间字段名。 | `expires_at` |
| `CLIENT_AUTH_USERNAME` | 可选，预置的授权用户名。 | 空（交互录入） |
| `CLIENT_AUTH_PASSWORD` | 可选，预置的授权密码。 | 空（交互录入） |

所有变量均已在 `.env.example` 中提供示例，复制后填写即可。

## 8. 异常处理与用户反馈
- 缓存损坏：自动删除并提示“重新验证”。
- 网络异常：抛出 "无法连接 Supabase" 提示，阻断启动。
- 密码错误：提示重新输入密码。
- 账号禁用或过期：输出明确提示，并要求联系管理员续期。
- 缺少环境变量：直接阻断启动并输出缺失项名称。

## 9. 后续迭代方向
1. 引入 Edge Function，对密码校验等逻辑进行服务端封装，减少客户端敏感数据暴露。
2. 增加设备指纹、并发控制与授权审计等扩展能力。
3. 将授权状态上报到监控系统，实现停用告警与使用分析。
4. 对本地缓存进行加密存储或接入系统级安全存储设施。

---
当前方案已经满足“启动前授权校验 + Supabase 托管 + 每日刷新”的上线要求，并为后续增强预留扩展点。