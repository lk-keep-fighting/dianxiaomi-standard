# 客户端授权方案

## 1. 背景与需求
- **使用场景**：数字酋长自动化系统的客户端需要在多台终端上运行，业务方希望按客户或终端颗粒度进行授权与限制。
- **核心诉求**：
  1. 每个客户端必须经过授权才能运行；
  2. 授权可远程管控，包括启用、禁用与设置使用期限；
  3. 授权有效期可随时调整，客户端需在可接受的延迟内感知变化；
  4. 在网络中断等异常场景下，客户端需具备合理的降级策略，既保证使用连续性又防止越权。

## 2. 设计目标
- **精确管控**：支持到“客户账户 + 终端/设备”级别的授权策略。
- **远程配置**：通过授权服务端统一配置授权信息（含有效期、状态、授权等级）。
- **安全可靠**：全链路加密传输，授权凭据不可伪造，授信时长无法被篡改。
- **可运维**：授权状态可视化、可审计，并支持批量操作、API 集成。
- **低侵入**：对现有客户端启动流程影响最小，改造后可通过统一授权 SDK 调用。

## 3. 关键角色与术语
| 角色 | 描述 |
| --- | --- |
| 客户端 (Client Agent) | 部署在客户侧的自动化执行程序。 |
| 授权服务 (License Service) | 统一管理客户端授权状态、有效期、策略的服务端系统。 |
| 授权控制台 (License Console) | 运维人员使用的管理后台，可视化查看授权状态并进行配置。 |
| 客户 (Customer) | 购买系统授权的组织或个人。 |
| 终端/设备 (Device) | 客户端运行的具体节点，可按机器指纹识别。 |

> **机器指纹**：由硬件信息（CPU 序列号、磁盘序列号、MAC 地址等）和系统环境生成的稳定标识，用于区分不同设备。

## 4. 总体架构
```
┌────────────────┐        HTTPS        ┌────────────────────┐
│ 授权控制台 UI  │ ──────────────────▶ │ 授权服务 API 网关  │
└────────────────┘                    └────────────────────┘
                                                  │
                                                  ▼
                                     ┌────────────────────────┐
                                     │ 授权核心服务 (License) │
                                     └────────────────────────┘
                                                  │
                                                  ▼
                                     ┌────────────────────────┐
                                     │ 数据库 & 配置存储       │
                                     └────────────────────────┘

客户端 ←→（定时拉取 / 心跳上报）←→ 授权服务 API 网关
```

### 4.1 组件说明
- **授权控制台**：提供授权的录入、调整、审核、导出等功能。支持用户、客户、机器三个层级的管理。
- **授权服务 API 网关**：对外暴露 RESTful/GraphQL 接口，进行鉴权、限流和监控。可部署反向代理或使用 API Gateway + WAF 组合。
- **授权核心服务**：负责处理授权校验、有效期判定、签发授权令牌、心跳处理等业务逻辑。
- **数据存储**：推荐使用关系型数据库（例如 PostgreSQL/MySQL）保存授权记录，配合 Redis 做热数据缓存，提高查询性能。
- **客户端授权 SDK**：封装与授权服务的通信、缓存和本地策略，供现有 Python 客户端调用。

## 5. 授权数据模型设计
核心数据实体如下：

1. **customers**：客户信息。
   - `id` (UUID)
   - `name`
   - `status` (active/suspended)

2. **devices**：终端或设备。与客户多对一。
   - `id` (UUID)
   - `customer_id`
   - `fingerprint`（唯一索引）
   - `description`
   - `status` (active/disabled)

3. **licenses**：授权记录。
   - `id`
   - `device_id`
   - `license_key`（可选，用于人工激活）
   - `license_type`（trial/full/enterprise 等）
   - `expires_at`
   - `grace_period_hours`
   - `max_concurrent_sessions`
   - `metadata`（JSON，扩展字段）

4. **license_audits**：授权变更日志。
   - `id`
   - `license_id`
   - `action`（issue/update/revoke/extend）
   - `operator`
   - `detail`
   - `created_at`

5. **device_heartbeats**（可选）：记录客户端最近一次上报，用于监控在线状态。

## 6. 授权流程设计

### 6.1 初始化与激活
1. 客户端启动时读取本地缓存的授权令牌（若存在）。
2. 若无令牌或令牌过期，客户端向授权服务发起 `POST /licenses/activate` 请求，携带：
   - 客户标识（客户密钥或账号）
   - 设备指纹
   - 客户端版本、操作系统等信息
3. 授权服务校验客户状态、设备状态：
   - 若新设备且策略允许自动登记，则创建 `device` 记录并下发授权；
   - 若需要人工审批，则返回待审批状态。
4. 授权服务返回签名的授权令牌（JWT / JWE），包含 `device_id`、`expires_at`、`grace_period_hours` 等字段。
5. 客户端将令牌安全持久化（加密存储在本地）。

### 6.2 启动校验
- 客户端在每次启动时做本地校验：
  1. 验证令牌签名及过期时间；
  2. 若当前时间 > `expires_at` + `grace_period`，立即拒绝运行；
  3. 若处于宽限期内，提示用户并进入“受限模式”或限制执行次数。
- 并发控制：令牌中可带 `max_concurrent_sessions`，客户端在启动心跳时需标注 session_id，服务端在心跳维持会话数量。

### 6.3 心跳与远程更新检测
- 客户端定时（如每 10 分钟）向授权服务发送 `POST /licenses/heartbeat`：
  - 内容：`device_id`、`token_id`、`session_id`、当前版本、运行状态。
- 服务端返回：
  - 最新授权摘要（`expires_at`、`status`、`features`）
  - 若状态有变更（例如远程缩短有效期、禁用设备），客户端立即生效。
- 为降低服务端压力，令牌内可包含 `policy_version`，客户端仅在本地缓存版本落后时拉取完整版授权。

### 6.4 远程控管场景
| 场景 | 操作 | 客户端响应 |
| --- | --- | --- |
| 提前终止授权 | 控制台将 license 状态改为 disabled | 客户端心跳响应中收到禁用指令，立即停止运行并提示。 |
| 延长使用期限 | 控制台更新 `expires_at` | 客户端下个心跳后刷新本地授权，延长有效期。 |
| 批量暂停客户 | 控制台将 customer 状态置为 suspended | 所有设备在下一次校验或心跳时进入禁用状态。 |
| 紧急封禁设备 | 控制台添加设备黑名单 | 授权服务返回黑名单状态，客户端立即拒绝运行。 |

## 7. 安全设计
- **通信安全**：全部接口使用 HTTPS + TLS1.2 以上；考虑部署 WAF 防护常见攻击。
- **令牌签名**：使用非对称加密（RSA/ECDSA）签发 JWT/JWE，客户端仅保存公钥，防止伪造。
- **客户端认证**：客户端在调用授权 API 时需携带客户级 `client_id` 和 `client_secret` 或预置的激活码，并结合设备指纹。
- **数据保护**：本地缓存的令牌使用系统安全存储（如加密文件、Windows DPAPI、macOS Keychain）。
- **重放防护**：令牌内包含 `token_id` 与 `issue_time`，服务端在心跳或续期时校验是否为最新令牌。
- **灰度控制**：支持针对特定客户或版本启用/禁用某些功能，避免一次性全量发布导致风险。

## 8. 异常与降级策略
| 异常 | 描述 | 客户端策略 |
| --- | --- | --- |
| 网络不可用 | 无法访问授权服务 | 允许在令牌未过期且未超出宽限期的情况下继续运行；记录告警日志。 |
| 服务端异常 | 授权接口返回 5xx | 重试（指数退避），若持续失败按网络不可用处理。 |
| 时间漂移 | 本地时间与授权服务差异过大 | 在心跳响应中返回时间校正信息，客户端校正后再校验。 |
| 指纹变化 | 硬件更换导致机器指纹不一致 | 按策略决定：允许一次自动迁移或进入人工审核。 |

## 9. 运维与监控
- **监控指标**：
  - 授权请求成功率、延迟
  - 心跳活跃设备数、离线设备数
  - 令牌签发量、失效量
  - 异常告警（重复激活、黑名单触发）
- **审计日志**：记录每次授权变更、管理员操作及客户端请求。
- **告警策略**：当某客户大量设备在短时间内失败或新设备激增时，触发安全告警。
- **备份**：授权数据库每日备份，敏感数据加密存储。

## 10. 实施路径建议
1. **阶段一 - 架构搭建**
   - 搭建授权数据库模型与基础 API。
   - 实现授权控制台的基本录入功能。
2. **阶段二 - 客户端集成**
   - 封装 Python 授权 SDK，完成激活、心跳、缓存的核心流程。
   - 在主程序启动流程中增加授权校验逻辑。
3. **阶段三 - 安全与监控**
   - 上线 HTTPS、签名校验、黑名单、灰度策略。
   - 接入日志、Prometheus/Grafana 或类似监控系统。
4. **阶段四 - 优化迭代**
   - 支持离线授权包、批量导入导出、Webhook 通知等。
   - 持续优化控制台体验与运营报表。

## 11. 后续关注点
- 评估授权策略与业务模式匹配度，例如是否需要计费、并发限制或功能分级。
- 根据客户分布选择合适的部署方式（自建 vs. 云服务），并规划多区域容灾。
- 与现有认证/用户系统的整合方式，减少重复账号体系。
- 明确客户端升级策略，确保授权 SDK 和主程序同步升级，避免出现旧版本绕过授权的风险。

---
以上方案为实现“客户端可远程配置使用期限”的初步设计，后续可依据业务规模和合规要求进一步细化。