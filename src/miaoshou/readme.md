# 妙手ERP订单收件人信息采集器 - 工作流程图

## 📊 完整流程可视化

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         工作流执行流程图                                  │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────┐
│ 1.触发器  │  [启动工作流]
└────┬─────┘
     │
     ▼
┌──────────────┐
│ 2.打开订单页面│  [访问 ERP 订单处理页面]
└────┬─────────┘  URL: https://erp.91miaoshou.com/order/package/index
     │            超时: 30秒
     ▼
┌──────────────┐
│ 3.等待页面加载│  [延迟 3 秒]
└────┬─────────┘  确保页面完全渲染
     │
     ▼
┌──────────────┐
│ 4.等待表格加载│  [检测表格元素]
└────┬─────────┘  选择器: .order-package-list-table
     │            重试: 10次，超时: 30秒
     │
     ├─────────────────┐
     │                 │
   存在              不存在
     │                 │
     ▼                 ▼
┌──────────────┐  ┌──────────┐
│ 5.滚动加载数据│  │15.错误提示│ [通知: 表格未找到]
└────┬─────────┘  └──────────┘  提示检查登录状态
     │                         └─► [结束]
     │  [滚动到底部]
     │  平滑滚动: 500px/次
     ▼
┌──────────────┐
│ 6.等待数据加载│  [延迟 2 秒]
└────┬─────────┘  等待滚动后的懒加载
     │
     ▼
┌──────────────┐
│ 7.获取所有订单行│ [提取订单行元素]
└────┬─────────┘  选择器: .order-package-item
     │            多个元素: 是
     ▼
┌──────────────┐
│ 8.循环遍历订单 │ ◄──────────────────────┐
└────┬─────────┘  [遍历每个订单]          │
     │            最大循环: 999次          │
     │                                    │
     ▼                                    │
┌──────────────┐                         │
│ 9.提取收件地区 │ [get-text]              │
└────┬─────────┘  选择器: .recipient-info .area-text
     │            变量: recipientArea      │
     ▼                                    │
┌──────────────┐                         │
│10.提取收件人姓名│[get-text]              │
└────┬─────────┘  选择器: .recipient-info .name-text
     │            变量: recipientName      │
     ▼                                    │
┌──────────────┐                         │
│11.提取联系电话 │ [get-text]              │
└────┬─────────┘  选择器: .recipient-info .phone-text
     │            变量: recipientPhone     │
     ▼                                    │
┌──────────────┐                         │
│12.提取省州邮编 │ [get-text]              │
└────┬─────────┘  选择器: .recipient-info .province-text
     │            变量: recipientProvince  │
     ▼                                    │
┌──────────────┐                         │
│13.保存收件人数据│[insert-data]            │
└────┬─────────┘  表ID: recipientData     │
     │            列: 收件地区、姓名、电话、邮编
     │                                    │
     └────────────────────────────────────┘
                     [继续下一个订单]
     
     循环结束后
     │
     ▼
┌──────────────┐
│ 14.导出数据   │  [export-data]
└──────────────┘  类型: CSV
                  文件名: 妙手ERP_收件人信息_{{date}}.csv
                  编码: UTF-8 with BOM
                  分隔符: 逗号
     │
     ▼
   [完成]
```

---

## 🔄 节点详细说明

### 第一阶段：初始化 (节点1-4)

#### 节点1: 触发器
```yaml
类型: trigger
功能: 手动或定时启动工作流
输出: 连接到节点2
```

#### 节点2: 打开订单页面
```yaml
类型: new-tab
功能: 在新标签页中打开目标URL
参数:
  - url: https://erp.91miaoshou.com/order/package/index?appPackageTab=waitProcess
  - active: true (激活标签页)
  - loadTimeout: 30000ms (30秒超时)
输入: 节点1
输出: 节点3
```

#### 节点3: 等待页面加载
```yaml
类型: delay
功能: 给予页面足够的渲染时间
参数:
  - time: 3000ms (3秒)
输入: 节点2
输出: 节点4
```

#### 节点4: 等待表格加载
```yaml
类型: element-exists
功能: 检测订单表格是否存在
参数:
  - selector: .order-package-list-table
  - tryCount: 10 (最多尝试10次)
  - timeout: 30000ms (30秒超时)
  - waitForSelector: true
输入: 节点3
输出: 
  - 成功 → 节点5
  - 失败 → 节点15
```

---

### 第二阶段：数据加载 (节点5-7)

#### 节点5: 滚动加载数据
```yaml
类型: element-scroll
功能: 滚动页面触发懒加载
参数:
  - selector: body
  - scrollY: 500 (每次滚动500px)
  - smooth: true (平滑滚动)
  - scrollToBottom: true (滚动到底部)
  - incY: true (增量滚动)
输入: 节点4 (成功分支)
输出: 节点6
```

#### 节点6: 等待数据加载
```yaml
类型: delay
功能: 等待滚动后的数据加载
参数:
  - time: 2000ms (2秒)
输入: 节点5
输出: 节点7
```

#### 节点7: 获取所有订单行
```yaml
类型: get-text
功能: 提取页面中所有订单行元素
参数:
  - selector: .order-package-item
  - multiple: true (多个元素)
  - assignVariable: true
  - variableName: orderRows
输入: 节点6
输出: 节点8
```

---

### 第三阶段：循环采集 (节点8-13)

#### 节点8: 循环遍历订单
```yaml
类型: loop-data
功能: 遍历每个订单行
参数:
  - loopThrough: elements (元素循环)
  - elementSelector: .order-package-item
  - maxLoop: 999 (最多999条)
  - loopId: orderLoop
输入: 节点7
输出:
  - 循环中 → 节点9
  - 循环结束 → 节点14
```

#### 节点9-12: 数据提取节点

**节点9: 提取收件地区**
```yaml
类型: get-text
选择器: .recipient-info .area-text
变量: recipientArea
文本模式: true
输入: 节点8 (循环开始)
输出: 节点10
```

**节点10: 提取收件人姓名**
```yaml
类型: get-text
选择器: .recipient-info .name-text
变量: recipientName
文本模式: true
输入: 节点9
输出: 节点11
```

**节点11: 提取联系电话**
```yaml
类型: get-text
选择器: .recipient-info .phone-text
变量: recipientPhone
文本模式: true
输入: 节点10
输出: 节点12
```

**节点12: 提取省州邮编**
```yaml
类型: get-text
选择器: .recipient-info .province-text
变量: recipientProvince
文本模式: true
输入: 节点11
输出: 节点13
```

#### 节点13: 保存收件人数据
```yaml
类型: insert-data
功能: 将提取的数据插入到表格
参数:
  - insertTableId: recipientData
  - dataColumns:
      * 收件地区: {{variables.recipientArea}}
      * 收件人姓名: {{variables.recipientName}}
      * 联系电话: {{variables.recipientPhone}}
      * 省州邮编: {{variables.recipientProvince}}
输入: 节点12
输出: 节点8 (继续循环)
```

---

### 第四阶段：数据导出 (节点14)

#### 节点14: 导出数据
```yaml
类型: export-data
功能: 导出采集的数据为CSV文件
参数:
  - dataToExport: data-columns
  - tableId: recipientData
  - type: csv
  - filename: 妙手ERP_收件人信息_{{date}}
  - csvOptions:
      delimiter: ","
      withBOM: true (支持Excel中文显示)
输入: 节点8 (循环结束)
输出: [结束]
```

---

### 错误处理 (节点15)

#### 节点15: 错误提示
```yaml
类型: notification
功能: 显示错误通知
参数:
  - message: "未找到订单表格，请检查页面是否正确加载或是否需要登录"
  - duration: 5000ms (5秒)
输入: 节点4 (失败分支)
输出: [结束]
```

---

## 📈 数据流转示意

```
┌─────────────┐
│  页面元素    │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────┐
│       循环提取 (每个订单)             │
│  ┌──────────────────────────────┐  │
│  │ .recipient-info .area-text   │  │ → recipientArea
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │ .recipient-info .name-text   │  │ → recipientName
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │ .recipient-info .phone-text  │  │ → recipientPhone
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │ .recipient-info .province-text│ │ → recipientProvince
│  └──────────────────────────────┘  │
└───────────────┬─────────────────────┘
                │
                ▼
┌────────────────────────────────────┐
│      recipientData 表格             │
│ ┌────────┬──────┬──────┬──────┐  │
│ │收件地区│姓名  │电话  │邮编  │  │
│ ├────────┼──────┼──────┼──────┤  │
│ │ 数据1  │ ... │ ... │ ...  │  │
│ │ 数据2  │ ... │ ... │ ...  │  │
│ │  ...   │ ... │ ... │ ...  │  │
│ └────────┴──────┴──────┴──────┘  │
└────────────────┬───────────────────┘
                 │
                 ▼
┌────────────────────────────────────┐
│     妙手ERP_收件人信息_日期.csv      │
│                                    │
│  收件地区,收件人姓名,联系电话,省州邮编│
│  广东深圳,张三,13800138000,518000  │
│  北京朝阳,李四,13900139000,100000  │
│  ...                              │
└────────────────────────────────────┘
```

---

## ⏱️ 执行时间估算

| 阶段 | 预计时间 | 说明 |
|------|---------|------|
| 页面加载 | 3-10秒 | 取决于网络速度 |
| 表格检测 | 1-3秒 | 取决于页面复杂度 |
| 滚动加载 | 2-5秒 | 取决于订单数量 |
| 数据采集 | N×0.5秒 | N为订单数量 |
| 数据导出 | 1-2秒 | 取决于数据量 |
| **总计** | **约10秒 + N×0.5秒** | 100条订单约60秒 |

---

## 🎯 关键决策点

### 1. 表格是否存在？(节点4)
```
YES ──→ 继续数据采集流程
NO  ──→ 显示错误提示并结束
```

### 2. 循环是否继续？(节点8)
```
有更多订单 ──→ 继续提取下一条
无更多订单 ──→ 导出数据
达到最大值 ──→ 导出数据
```

### 3. 数据是否完整？(节点9-12)
```
每个节点都会尝试提取
如果元素不存在 → 变量为空字符串
不会中断流程
```

---

## 🔍 调试建议

### 开启调试模式
在配置文件中设置：
```json
"settings": {
  "debugMode": true
}
```

### 关键检查点

1. **节点4后**: 确认表格是否成功检测
2. **节点7后**: 检查orderRows变量，确认订单数量
3. **节点13**: 查看recipientData表格，确认数据是否正确插入
4. **节点14后**: 检查下载文件夹，确认CSV文件

### 常见问题定位

| 问题 | 检查节点 | 可能原因 |
|------|---------|---------|
| 无法打开页面 | 节点2 | URL错误、网络问题 |
| 表格未找到 | 节点4 | 未登录、选择器错误 |
| 数据不完整 | 节点7 | 滚动未完成 |
| 字段为空 | 节点9-12 | 选择器错误 |
| 无法导出 | 节点14 | 浏览器权限 |

---

## 📊 性能优化建议

### 1. 减少等待时间
```yaml
# 如果网络良好，可以减少延迟
节点3: 3000ms → 2000ms
节点6: 2000ms → 1000ms
```

### 2. 并行处理（未来版本）
```yaml
# 可以考虑分页并行采集
- 第1-50条: 工作流A
- 第51-100条: 工作流B
```

### 3. 增量采集
```yaml
# 只采集新订单
- 记录上次采集的最后订单ID
- 从该ID开始采集
```

---

**流程图版本**: 1.0  
**最后更新**: 2025-11-19