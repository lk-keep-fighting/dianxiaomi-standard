# 店小秘自动化系统用户手册（基于 src/main.py）

## 🧾 系统概述
店小秘自动化系统围绕 `src/main.py` 构建，使用 Playwright 驱动浏览器完成店小秘与亚马逊之间的数据自动化。程序启动后先通过 `ensure_client_authorized()` 校验 Supabase 授权，再由 `UserInteractionFlow` 提供的交互式界面引导用户完成登录与任务选择。核心的 `run_manual_mode()` 会定位采集箱中的“编辑”按钮，逐个打开产品编辑页，并交由 `process_product_edit_enhanced()` 联动 `parse_amazon_product_enhanced()`、`fill_edit_form_enhanced()` 与 `save_product_changes_enhanced()` 完成从抓取、回填到保存的闭环。产品数据使用 `ProductData` 作为单一数据源，异常信息通过 `csv_logger` 归档，保证流程稳定、可追踪。

## ✨ 核心特性简介
- 🔐 **授权与账号安全控制**：`ensure_client_authorized()` 通过 Supabase 验证客户授权，结果缓存于 `data/auth_states/`，阻止未授权账号运行。
- 🧭 **交互式作业体验**：`UserInteractionFlow` 提供欢迎界面、主菜单、进度提示与暂停确认，支持人工审核与自动批处理之间无缝切换。
- 🧽 **弹窗自愈能力**：`closeAdModal()` 持续扫描“关闭”“知道了”等按钮，自动清理采集箱常见弹窗，确保后续操作顺畅。
- 🧠 **增强版 Amazon 解析**：`parse_amazon_product_enhanced()` 调用 `AmazonProductParser`，自动处理反爬提示、地区邮编切换及滚动加载，提取标题、价格、运费、规格、卖点等核心要素。
- 📦 **单一数据源与映射治理**：`ProductData` 配合 `convert_weight_to_grams()`、`_parse_dimensions()` 等工具实现重量换算、尺寸标准化，并为表单字段映射提供可复用的字段仓。
- 🎯 **动态规格与 SKU 管理**：`handle_dynamic_specifications()` 和 `_remove_all_specifications_with_link()` 会解析 "Specifications Summary"，自动勾选目标规格、清除插头规格与冗余选项，保持 SKU 配置干净。
- 🖼️ **图片与素材批处理**：`fill_edit_form_enhanced()` 支持引用采集图片、批量调整 SKU/详情图尺寸、清空色块与冗余图片，保证素材合规统一。
- 📊 **异常与分类日志体系**：当分类异常或填充失败时，通过 `write_unreasonable_category_to_csv()`、`write_processing_exception_to_csv()` 生成 CSV 记录，`csv_logger.print_daily_summary()` 可随时输出当日统计。
- 🧪 **多模式测试工具**：`test_process_product_edit_enhanced()` 提供完整流程、仅填充、仅解析、规格测试四种模式，便于在真实页面验证流程。
- 🧱 **可拓展架构**：代码已预留 `UnifiedFormFiller` 与 `AICategoryValidator` 的接口位置，可根据业务需求迅速扩展为统一表单渲染或 AI 分类校验能力。

## 🔍 亚马逊解析能力概述

### 页面准备与防护
- `AmazonProductParser._prepare_page()` 自动点击 “Continue shopping” 等反爬提示，确保页面可访问。
- 自动检测并切换配送邮编到纽约 10001，保证展示价格及库存信息一致。
- 通过滚动到底部、回到顶部、再滚动中间的策略触发详情区块加载。

### 核心字段覆盖
- **基础信息**：产品标题 (`_parse_title()`)、ASIN、品牌、制造商、材质、颜色、风格等。
- **价格体系**：优先抓取非 Prime 的 Regular Price，并解析弹窗、隐藏域中的运费信息。
- **规格参数**：`_parse_specifications()`、`_parse_product_details_tables()` 汇集产品尺寸、重量、包装数量、安装方式等。
- **卖点亮点**：提取 Feature Bullets 与 Glance Icons，自动聚合到 Key Features 字段。
- **变种摘要**：生成 `Specifications Summary`、`Selected Color`、`Selected Package Quantity` 等数据，为 SKU 选择提供依据。

### 数据标准化与转换
- `convert_weight_to_grams()` 将磅数转换为克，满足店小秘表单要求。
- `_parse_dimensions()` + `_inches_to_cm()` 将英寸转为厘米，填充 `packageLength/Width/Height`。
- 数据全部写入 `ProductData.details`（键统一转为小写），保证后续映射稳定。

### 单一数据源优势
`ProductData` 既保存原始值也存储清洗结果，`to_dict()` 输出后即可被 `fill_edit_form_enhanced()` 消耗，实现一次解析、多处复用，避免重复请求和字段漂移。

## 🚀 快速上手

### 环境要求
- Python 3.10 及以上版本
- macOS / Linux / Windows (需启用 WSL) 均可运行
- 已安装 Google Chrome 或 Chromium（Playwright 会自动下载对齐版本）
- 可访问 Supabase 授权服务与 Amazon、店小秘站点的稳定网络

### 安装依赖
```bash
# 进入项目目录
cd /path/to/project

# 安装 Python 依赖
pip install -r requirements.txt

# 安装 Playwright Chromium 运行时
python -m playwright install chromium
```

### 授权与账号配置
1. 联系服务方获取 Supabase 凭证，并在启动前设置以下环境变量：
   ```bash
   export SUPABASE_URL="https://xxx.supabase.co"
   export SUPABASE_API_KEY="your_api_key"
   export CLIENT_AUTH_USERNAME="授权账号"
   export CLIENT_AUTH_PASSWORD="授权密码"
   # 可按需覆盖表名/字段：SUPABASE_CLIENT_TABLE、SUPABASE_USERNAME_COLUMN 等
   ```
2. 首次运行时程序会把授权结果写入 `data/auth_states/client_authorization_state.json`，同一日内无需重复验证。
3. 店小秘登录凭证位于 `src/main.py` 的 `user_name`、`password` 变量，可改为自己的账号或留空让脚本停留在登录页等待人工登录。出于安全考虑，请勿把真实密码提交到版本库。

### 首次启动
```bash
python src/main.py
```
- 选择主菜单 `[1]` 启动采集箱处理，按提示在浏览器完成登录后回到终端继续。
- 若需验证功能可选择 `[2]` 打开测试工具；`[3]` 退出程序。
- 授权状态会自动缓存，浏览器登录态也会存放在 `data/auth_states/{用户名}_auth_state.json`。

## 🧭 操作流程

1. **登录与页面准备**
   - 完成授权后，`run()` 打开浏览器并加载店小秘采集箱。
   - `closeAdModal()` 自动关闭弹窗，`ui.wait_for_confirmation()` 提示用户筛选待处理产品。

2. **采集箱循环（手动审核模式）**
   - `run_manual_mode()` 收集表格中的“编辑”按钮，统计待处理数量。
   - 每个产品处理完成后会统计成功/跳过/错误，并支持 `[Y]继续 / [N]终止 / [A]自动继续` 三种模式。

3. **编辑页解析与预览**
   - `process_product_edit_enhanced()` 等待 `sourceUrl` 输入框出现并多次轮询，解决店小秘加载延迟问题。
   - 利用 `parse_amazon_product_enhanced()` 抓取 Amazon 数据，并通过 `show_product_preview_for_dianxiaomi()` 为用户提供 `继续 / 跳过 / 查看详情` 三种选择。
   - 若解析失败或用户选择跳过，处理器会关闭编辑页并记录日志。

4. **表单智能填充**
   - `fill_edit_form_enhanced()` 将解析结果映射到店小秘字段，涵盖：
     - ASIN、标题、价格（含运费）、库存默认值等。
     - 通过 `convert_weight_to_grams()`、`depth_cm/width_cm/height_cm` 填写物流信息。
     - `handle_dynamic_specifications()` 自动匹配颜色、尺码等规格，移除插头规格与冗余项。
     - SKU 图片引用与批量 1:1 裁剪、详情图清理、色块清空等视觉素材处理。
   - 若需要表格填充，将检测是否存在 SKU 表并补齐货号。

5. **保存与异常捕获**
   - `save_product_changes_enhanced()` 智能定位“保存”按钮，支持备用选择器与 ESC 兜底。
   - 若保存失败或流程异常，会调用 `write_processing_exception_to_csv()` 记录错误详情，便于后续排查。

6. **流程收尾**
   - 全量处理结束后输出汇总统计，并调用 `csv_logger.print_daily_summary()` 显示当日 CSV 日志情况。
   - 用户按提示退出程序，浏览器与上下文自动关闭。

## 💡 吸引用户下单的卖点

- ⚡ **效率倍增**：单个商品平均 5–10 秒完成解析与填充，支持自动续航模式，无需人工重复点击。
- 🎯 **高准确率**：动态规格匹配、重量尺寸换算、卖点聚合等细节保证填充数据即插即用，减少售后返工。
- 🛡️ **风控到位**：Supabase 授权、授权状态缓存、异常 CSV 追踪三管齐下，保障账号安全与问题可追诉。
- 📸 **视觉素材合规**：自动批量调整 SKU/详情图比例、清空残余图片，确保刊登素材一次成稿。
- 🧪 **透明可验**：内置测试模式与产品预览，让用户在每一步都有确认权，降低自动化介入的不确定性。
- 🔄 **扩展空间充足**：预留统一表单填充与 AI 分类接口，可根据业务发展继续加装自动化模块，保护投入价值。

## 🧪 测试与诊断工具

### 测试模式
使用命令 `python src/main.py --test` 启动测试工具，可在真实店小秘编辑页上验证以下模块：

| 选项 | 功能范围 | 适用场景 |
| --- | --- | --- |
| 1 | 完整流程（解析 + 填充 + 保存模拟） | 全面回归或上线前自测 |
| 2 | 仅表单填充 | 验证映射、图片、规格操作 |
| 3 | 仅 Amazon 解析 | 检查链接可用性与字段覆盖情况 |
| 4 | 仅规格选择 | 调试颜色/尺寸等规格匹配逻辑 |

选择后脚本会在执行完毕时调用 `ui.pause_for_review()` 等待用户检查页面。

### 日志与输出
- 分类异常 CSV：`unreasonable_categories_YYYYMMDD.csv`
- 处理异常 CSV：`processing_exceptions_YYYYMMDD.csv`
- 文件默认保存在运行目录，可通过 `csv_logger.print_daily_summary()` 即时查看当日统计。
- Playwright 控制台日志会打印在终端，方便实时观察流程。

## ❓ 常见问题

### 1. 授权失败或提示缺少环境变量？
请确认已设置 `SUPABASE_URL`、`SUPABASE_API_KEY`、`CLIENT_AUTH_USERNAME`、`CLIENT_AUTH_PASSWORD`。若首次运行后仍失败，删除 `data/auth_states/client_authorization_state.json` 重新验证。

### 2. 浏览器无法启动或提示缺少组件？
执行 `python -m playwright install --with-deps chromium` 安装运行依赖；若在 Linux 服务器，请确认具备 GUI 或使用带界面的远程环境。

### 3. `sourceUrl` 长时间为空导致流程卡住？
脚本在 `process_product_edit_enhanced()` 中最多轮询 12 次，每次间隔 1 秒。若仍为空，请检查店小秘页面是否被弹窗遮挡或网络过慢，可手动刷新后再次运行。

### 4. 自动规格选择结果与预期不符？
查看预览时选择 `[D]` 查看解析详情，确认 Amazon 页是否有 `Specifications Summary`。脚本提供 `_fallback_specification_selection()` 备用逻辑，必要时可手动勾选并继续保存。

### 5. Amazon 页面被反爬拦截？
`AmazonProductParser` 会自动尝试点击 “Continue shopping”，若仍失败，请手动在弹窗中完成验证或稍候重试，避免短时间内频繁请求同一链接。

## 📞 支持与反馈

- 日志与截图：当遇到异常时，请保留终端输出、相关 CSV 文件与浏览器截图，便于技术支持快速定位。
- 配置备份：建议把授权及店小秘账号配置保存到安全的私密仓库或环境变量管理工具，避免丢失。
- 更新建议：若需引入统一表单填充、AI 分类模型或多站点扩展，可参考 `archive/` 目录下的架构文档并联系开发团队。

祝您使用愉快，享受高效、稳定的自动化体验！